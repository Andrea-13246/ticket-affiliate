name: AutoPost Telegram Events

on:
  schedule:
    - cron: '0 * * * *'   # ogni ora
  workflow_dispatch:

jobs:
  send_event:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y shuf

      - name: Send random event to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          FILE="events.csv"
          if [ ! -f "$FILE" ]; then
            echo "File $FILE non trovato!"
            exit 1
          fi

          # Scegli una categoria a caso
          CATEGORY=$(awk -F',' 'NR>1 {print $10}' "$FILE" | sort | uniq | shuf -n1)
          echo "üé≤ Categoria scelta: $CATEGORY"

          # Scegli un evento a caso di quella categoria
          EVENT=$(awk -F',' -v cat="$CATEGORY" 'NR>1 && $10==cat {print $0}' "$FILE" | shuf -n1)

          TITLE=$(echo "$EVENT" | cut -d',' -f1)
          CITY=$(echo "$EVENT" | cut -d',' -f2)
          VENUE=$(echo "$EVENT" | cut -d',' -f3)
          DATE=$(echo "$EVENT" | cut -d',' -f4)
          TIME=$(echo "$EVENT" | cut -d',' -f5)
          PRICE=$(echo "$EVENT" | cut -d',' -f6)
          URL=$(echo "$EVENT" | cut -d',' -f7)
          AFFID=$(echo "$EVENT" | cut -d',' -f8)
          IMAGE=$(echo "$EVENT" | cut -d',' -f9)

          TEXT="üéüÔ∏è *${TITLE}*\nüìç ${CITY} ‚Äì ${VENUE}\nüìÖ ${DATE} ‚è∞ ${TIME}\nüí∂ ${PRICE}‚Ç¨\n\n[Compra ora](${URL}?affid=${AFFID})"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto" \
            -F chat_id="${TELEGRAM_CHAT_ID}" \
            -F photo="${IMAGE}" \
            -F parse_mode="Markdown" \
            -F caption="$TEXT"
