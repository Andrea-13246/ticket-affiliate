name: AutoPost Telegram Events CSV

on:
  schedule:
    - cron: '0 * * * *'  # ogni ora
  workflow_dispatch:

jobs:
  send_event_csv:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Send latest event to Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          FILE="events.csv"

          if [ ! -f "$FILE" ]; then
            echo "‚ùå File $FILE non trovato!"
            exit 1
          fi

          # Leggi la prima riga di dati (salta intestazione)
          IFS=',' read -r TITLE CITY VENUE DATE TIME PRICE URL AFF IMAGE < <(tail -n +2 "$FILE" | head -n 1)

          FINAL_URL="${URL}?aff=${AFF}"
          CAPTION="<b>${TITLE}</b>%0Aüìç ${CITY} ‚Äî ${VENUE}%0AüóìÔ∏è ${DATE} alle ${TIME}%0Aüí∂ Prezzo: ‚Ç¨${PRICE}%0A%0A<a href='${FINAL_URL}'>üéüÔ∏è Acquista ora</a>"

          echo "üì§ Invio evento: $TITLE"
          echo "üñºÔ∏è Immagine: $IMAGE"

          RESPONSE=$(curl -s \
            -G "https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto" \
            --data-urlencode "chat_id=${CHAT_ID}" \
            --data-urlencode "photo=${IMAGE}" \
            --data-urlencode "caption=${CAPTION}" \
            --data-urlencode "parse_mode=HTML")

          echo "Risposta Telegram: $RESPONSE"
