name: AutoPost Telegram Events

on:
  schedule:
    - cron: '0 * * * *'  # ogni ora
  workflow_dispatch:

jobs:
  send_event:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Send latest event to Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          FILE="events.json"

          if [ ! -f "$FILE" ]; then
            echo "‚ùå File $FILE non trovato!"
            exit 1
          fi

          EVENT=$(jq '.[0]' "$FILE")

          TITLE=$(echo "$EVENT" | jq -r '.title')
          CITY=$(echo "$EVENT" | jq -r '.city')
          VENUE=$(echo "$EVENT" | jq -r '.venue')
          DATE=$(echo "$EVENT" | jq -r '.date')
          PRICE=$(echo "$EVENT" | jq -r '.price')
          URL=$(echo "$EVENT" | jq -r '.url')
          AFF=$(echo "$EVENT" | jq -r '.affid')
          IMAGE=$(echo "$EVENT" | jq -r '.image')

          FINAL_URL="${URL}?aff=${AFF}"
          CAPTION="<b>${TITLE}</b>%0Aüìç ${CITY} ‚Äî ${VENUE}%0AüóìÔ∏è ${DATE}%0Aüí∂ Prezzo: ‚Ç¨${PRICE}%0A%0A<a href='${FINAL_URL}'>üéüÔ∏è Acquista ora</a>"

          echo "üì§ Invio immagine da: $IMAGE"

          RESPONSE=$(curl -s "https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto?chat_id=${CHAT_ID}&photo=${IMAGE}&caption=${CAPTION}&parse_mode=HTML")

          echo "Risposta Telegram: $RESPONSE"
